<!DOCTYPE html>
<html lang="en">

<head>
  <title>Create Role Listings</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  <link rel="stylesheet" href="css/custom-bs.css" />
  <link rel="stylesheet" href="css/jquery.fancybox.min.css" />
  <link rel="stylesheet" href="css/bootstrap-select.min.css" />
  <link rel="stylesheet" href="fonts/icomoon/style.css" />
  <link rel="stylesheet" href="fonts/line-icons/style.css" />
  <link rel="stylesheet" href="css/owl.carousel.min.css" />
  <link rel="stylesheet" href="css/animate.min.css" />
  <link rel="stylesheet" href="css/quill.snow.css" />

  <!-- MAIN CSS -->
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body id="top">
  <div id="overlayer"></div>
  <div class="loader">
    <div class="spinner-border text-primary" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>

  <div class="site-wrap">
    <div class="site-mobile-menu site-navbar-target">
      <div class="site-mobile-menu-header">
        <div class="site-mobile-menu-close mt-3">
          <span class="icon-close2 js-menu-toggle"></span>
        </div>
      </div>
      <div class="site-mobile-menu-body"></div>
    </div>
    <!-- .site-mobile-menu -->

    <!-- NAVBAR -->
    <div id="navbar-placeholder"></div>

    <script>
      $(function () {
        $("#navbar-placeholder").load("navbar.html");
      });
    </script>

    <!-- HOME -->
    <section class="section-hero overlay inner-page bg-image" style="background-image: url('images/hero_1.jpg')"
      id="home-section">
      <div class="container">
        <div class="row">
          <div class="col-md-7">
            <h1 class="text-white font-weight-bold">Create Role Listing</h1>
            <div class="custom-breadcrumbs">
              <a href="#">Home</a> <span class="mx-2 slash">/</span>
              <a href="#">Job</a> <span class="mx-2 slash">/</span>
              <span class="text-white"><strong>Post a Job</strong></span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="site-section">
      <div class="container">
        <div class="row align-items-center mb-5">
          <div class="col-lg-8 mb-4 mb-lg-0">
            <div class="d-flex align-items-center">
              <div>
                <h2>Create Role Listing</h2>
              </div>
            </div>
          </div>
        </div>
        <div class="row mb-5">
          <div class="col-lg-12">
            <form class="p-4 p-md-5 border rounded" method="post">
              <h3 class="text-black mb-5 border-bottom pb-2">Role Details</h3>

              <div class="form-group">
                <label for="role_title">Role Title</label>
                <input type="text" class="form-control" id="role_title" placeholder="Enter Role Title..." />
              </div>

              <div class="form-group">
                <label>Skills Required</label>
                <div class="dropdown">
                  <button class="btn btn-secondary dropdown-toggle" type="button" id="skills-dropdown"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Select Skills
                  </button>
                  <div class="dropdown-menu" aria-labelledby="skills-dropdown">
                    <div id="skillForm">
                    </div>

                  </div>
                </div>
                <div id="selected-skills"></div>
              </div>

              <div class="form-group">
                <label for="role_desc">Role Description</label>
                <textarea class="form-control" id="role_desc" rows="3"></textarea>
              </div>

              <div class="form-group">
                <label for="listing_desc">Listing Description</label>
                <textarea class="form-control" id="listing_desc" rows="3"></textarea>
              </div>

              <div class="form-group">
                <label for="manager">Manager</label>
                <select class="form-control" id="manager">
                </select>
              </div>

              <div class="form-group">
                <label for="opening_date" class="form-label">Opening Date</label>
                <input type="date" class="form-control" id="opening_date" name="opening_date" required />
              </div>

              <div class="form-group">
                <label for="closing_date" class="form-label">Closing Date</label>
                <input type="date" class="form-control" id="closing_date" name="closing_date" required />
              </div>

              <div class="mb-3">
                <label for="visibility" class="form-label">Visibility</label>
                <br />
                <select class="form-select" id="visibility" name="visibility" required>
                  <option value="public">Public</option>
                  <option value="private">Private</option>
                </select>
              </div>
            </form>
          </div>
        </div>
        <div class="row align-items-center mb-5">
          <div class="col-lg-4 ml-auto">
            <div class="row">
              <div class="col-6">
                <button class="btn btn-block btn-primary btn-md" onclick="createListing()">Create Role Listing</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="site-footer">
      <a href="#top" class="smoothscroll scroll-top">
        <span class="icon-keyboard_arrow_up"></span>
      </a>

      <div class="row text-center">
        <div class="col-12">
          <p class="copyright">
            <small>
              <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
              Copyright &copy;
              <script>
                document.write(new Date().getFullYear());
              </script>
              All rights reserved | This template is made with
              <i class="icon-heart text-danger" aria-hidden="true"></i> by
              <a href="https://colorlib.com" target="_blank">Colorlib</a>
              <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
            </small>
          </p>
        </div>
      </div>
  </div>
  </footer>
  </div>

  <!-- SCRIPTS -->
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="js/isotope.pkgd.min.js"></script>
  <script src="js/stickyfill.min.js"></script>
  <script src="js/jquery.fancybox.min.js"></script>
  <script src="js/jquery.easing.1.3.js"></script>

  <script src="js/jquery.waypoints.min.js"></script>
  <script src="js/jquery.animateNumber.min.js"></script>
  <script src="js/owl.carousel.min.js"></script>
  <script src="js/quill.min.js"></script>

  <script src="js/bootstrap-select.min.js"></script>

  <script src="js/custom.js"></script>

  <script>
    var selectedSkillsId = []
    const currentUser = 123456788
    async function loadSkills() {

      try {
        const res = await fetch('http://localhost:5001/skills');
        const data = await res.json();
        for (let skill of data.data.skill) {
          document.getElementById("skillForm").innerHTML += `
            <div>
              <input type="checkbox" id="${skill.skill_id}" name="${skill.skill_name}" value="${skill.skill_id}">
              <label for="${skill.skill_id}">${skill.skill_name}</label>
              </div>
          `
        }
        const checkboxes = document.querySelectorAll('input[type="checkbox"]')
        const selectedSkills = document.getElementById('selected-skills')
        checkboxes.forEach(checkbox => {
          checkbox.addEventListener('change', () => {
            selectedSkillsId.length = 0
            const selectedCheckboxes = Array.from(checkboxes).filter(checkbox => {
              if (checkbox.checked) {
                selectedSkillsId.push(checkbox.value)
              }
              return checkbox.checked
            });
            const selectedSkillsText = selectedCheckboxes.map(checkbox => checkbox.labels[0].textContent).join(', ')
            selectedSkills.textContent = selectedSkillsText
          });
        });
      } catch (err) {
        console.error('An error occurred:', err)
      }
    }

    async function loadManagers() {
      try {
        const res = await fetch('http://localhost:5000/staff');
        const data = await res.json();
        for (let staff of data.data.staff) {
          document.getElementById("manager").innerHTML += `
            <option value=${staff.staff_id}>${staff.fname} ${staff.lname}</option>
          `
        }
      } catch (err) {
        console.error('An error occurred:', err)
      }
    }

    async function createListing() {
      const roleTitle = document.getElementById("role_title").value
      const roleDesc = document.getElementById("role_desc").value
      const id = await generateId()

      const roleData = {
        role_id: id,
        role_name: roleTitle,
        role_description: roleDesc,
        role_status: "active"
      }

      try {
        await fetch('http://localhost:5002/roles', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(roleData)
        })
      } catch (err) {
        console.error('An error occurred:', err)
      }

      for (skill of selectedSkillsId) {
        const roleSkill = {
          role_id: id,
          skill_id: parseInt(skill)
        }

        try {
          await fetch('http://localhost:5001/role-skill', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(roleSkill)
          })
        } catch (err) {
          console.error('An error occurred:', err)
        }
      }

      const listingDesc = document.getElementById("listing_desc").value
      const manager = document.getElementById("manager").value
      const openingDate = document.getElementById("opening_date").value
      const closingDate = document.getElementById("closing_date").value
      const currentDate = new Date().toISOString().split('T')[0]
      const listingId = await generateListingId()
      const listingData = {
        role_listing_id: listingId,
        role_id: id,
        role_listing_desc: listingDesc,
        role_listing_source: manager,
        role_listing_open: openingDate,
        role_listing_close: closingDate,
        role_listing_creator: currentUser,
        role_listing_ts_create: currentDate,
        role_listing_updater: currentUser,
        role_listing_ts_update: currentDate
      }

      try {
          await fetch('http://localhost:5002/role-listings', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(listingData)
          })
        } catch (err) {
          console.error('An error occurred:', err)
        }
    }

    async function generateId() {
      try {
        const res = await fetch('http://localhost:5002/roles')
        const data = await res.json()
        let id = 234567890 + data.data.role.length + 1;
        return id
      } catch (err) {
        console.error('An error occurred:', err)
      }
    }

    async function generateListingId() {
      try {
        const res = await fetch('http://localhost:5002/role-listings')
        const data = await res.json()
        let id = 123455 + data.data.listing.length + 1;
        return id
      } catch (err) {
        console.error('An error occurred:', err)
      }
    }

    loadSkills()
    loadManagers()

  </script>
</body>

</html>